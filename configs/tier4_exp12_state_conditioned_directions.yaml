# Tier 4 - Experiment 12: State-Conditioned Directional Structure in VAE Latent Dynamics
#
# Implements Experiments 1–6 from TIER4_EXPERIMENTs.md.
#
# Default paths target the already-generated PocketMimiVAE 32D latents from:
#   outputs/tier2/exp9_pocket_mimi_vae/20260209_010912

seed: 42
seeds: [11, 22, 33]          # used for k-means init + shuffles

data:
  latents_dir: ./outputs/tier2/exp9_pocket_mimi_vae/20260210_064617/latents.zarr
  latents_index: ./outputs/tier2/exp9_pocket_mimi_vae/20260210_064617/latents_index.parquet
  splits_dir: ./outputs/phase0/splits

preprocess:
  # Near-zero deltas: filter if ||δ|| < eps_mult * median(||δ||).
  eps_mult: 1.0e-4
  min_deltas_per_cluster: 50
  # Optional caps for quick runs (null = no cap).
  max_utterances: null
  max_deltas: null

exp1_global:
  k_global: [16, 32, 64, 128, 256, 512, 1024]
  hist_bin_deg: 5

exp2_states:
  k1: [64, 512, 2048]

exp3_conditional:
  k2: [4, 16, 64]
  shuffled_null_repeats: 5

exp4_bigram:
  enabled: true

exp5_perceptual:
  enabled: true
  # Exp9 checkpoint contains full Mimi weights ("mimi_full") so no downloads are needed.
  vae_checkpoint: ./outputs/tier2/exp9_pocket_mimi_vae/20260210_064617/checkpoints/vae_gan_step40000.pt
  # Choose best conditional config from exp3 automatically.
  # Optional overrides:
  #   k1: 2048
  #   k2_values: [16, 32, 64]
  #   state_seed: 11
  n_utterances: 20
  output_sample_rate: 48000
  metrics_sample_rate: 16000
  mel_n_mels: 80
  # Global delta codebook size for comparison in Exp5.
  global_k: 1024
  save_audio: true

exp6_scaling:
  enabled: true

kmeans:
  # MiniBatchKMeans params (used everywhere).
  n_init: 3
  max_iter: 300
  batch_size: 8192

compute:
  # Set to 1 to avoid OpenMP oversubscription when parallelizing per-state fits.
  omp_num_threads: 1
  # Parallel workers for per-cluster fits (0/1 = disable).
  n_workers: 8

output:
  out_dir: ./outputs/tier4/exp12_state_conditioned_directions
